(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[961],{2034:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/articles/memory_consistency_model",function(){return r(1045)}])},1045:function(e,t,r){"use strict";r.r(t),r.d(t,{__toc:function(){return d},default:function(){return h}});var a=r(5250),n=r(3010),s=r(2630),i=r(9251);r(1541);var l=r(895),o={src:"/_next/static/media/cpu_memory_ordering_in_some_architectures.840f5e7f.png",height:785,width:1530,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAECAIAAAA8r+mnAAAAX0lEQVR42h3JMQ6AIAxAUe5/KQ+hRmMkaggFQVpcSjEOEpc//KcuutEA+XAaG+clhnQlQswqUOZhrBZk29+ua2XnxZ8/TDMbw+CefpBVF3BiQcUGWteEBUnaOg5uh8sHDRJXquzJ7XUAAAAASUVORK5CYII=",blurWidth:8,blurHeight:4};let d=[{depth:2,value:"TSO (Total Store Ordering)",id:"tso-total-store-ordering"},{depth:3,value:"Can be reordered",id:"can-be-reordered"},{depth:3,value:"如何理解（因无法验证，仅供参考）：",id:"如何理解因无法验证仅供参考"},{depth:2,value:"PSO (Part Store Ordering)",id:"pso-part-store-ordering"},{depth:3,value:"Can be reordered",id:"can-be-reordered-1"},{depth:3,value:"如何理解（因无法验证，仅供参考）：",id:"如何理解因无法验证仅供参考-1"},{depth:2,value:"RMO (Relaxed Memory Ordering)",id:"rmo-relaxed-memory-ordering"},{depth:3,value:"Can be reordered",id:"can-be-reordered-2"},{depth:3,value:"如何理解（因无法验证，仅供参考）：",id:"如何理解因无法验证仅供参考-2"},{depth:2,value:"关于 编译器屏障 与 内存屏障",id:"关于-编译器屏障-与-内存屏障"},{depth:3,value:"编译器屏障",id:"编译器屏障"},{depth:3,value:"内存屏障",id:"内存屏障"}];function _createMdxContent(e){let t=Object.assign({h1:"h1",p:"p",img:"img",h2:"h2",h3:"h3",ul:"ul",li:"li",input:"input",pre:"pre",code:"code",span:"span"},(0,l.a)(),e.components);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.h1,{children:"内存一致性模型"}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"cpu memory ordering in some architectures",placeholder:"blur",src:o})}),"\n",(0,a.jsx)(t.p,{children:"因作者水平有限，本文仅讨论 x86 架构 (TSO) 与 ARMv8 架构 (RMO)，以此加深作者本人对硬件并行部分的知识的理解。"}),"\n",(0,a.jsx)(t.h2,{id:"tso-total-store-ordering",children:"TSO (Total Store Ordering)"}),"\n",(0,a.jsx)(t.h3,{id:"can-be-reordered",children:"Can be reordered"}),"\n",(0,a.jsxs)(t.ul,{className:"contains-task-list",children:["\n",(0,a.jsxs)(t.li,{className:"task-list-item",children:[(0,a.jsx)(t.input,{type:"checkbox",disabled:!0})," ","Load Load"]}),"\n",(0,a.jsxs)(t.li,{className:"task-list-item",children:[(0,a.jsx)(t.input,{type:"checkbox",disabled:!0})," ","Load Store"]}),"\n",(0,a.jsxs)(t.li,{className:"task-list-item",children:[(0,a.jsx)(t.input,{type:"checkbox",checked:!0,disabled:!0})," ","Store Load"]}),"\n",(0,a.jsxs)(t.li,{className:"task-list-item",children:[(0,a.jsx)(t.input,{type:"checkbox",disabled:!0})," ","Store Store"]}),"\n"]}),"\n",(0,a.jsx)(t.h3,{id:"如何理解因无法验证仅供参考",children:"如何理解（因无法验证，仅供参考）："}),"\n",(0,a.jsx)(t.p,{children:"CPU 拥有 Store Buffer，当需要 Load 时，如果其它 CPU 没有及时刷出 Store Buffer 则会发生 Store Load 重排序。"}),"\n",(0,a.jsx)(t.h2,{id:"pso-part-store-ordering",children:"PSO (Part Store Ordering)"}),"\n",(0,a.jsx)(t.h3,{id:"can-be-reordered-1",children:"Can be reordered"}),"\n",(0,a.jsxs)(t.ul,{className:"contains-task-list",children:["\n",(0,a.jsxs)(t.li,{className:"task-list-item",children:[(0,a.jsx)(t.input,{type:"checkbox",disabled:!0})," ","Load Load"]}),"\n",(0,a.jsxs)(t.li,{className:"task-list-item",children:[(0,a.jsx)(t.input,{type:"checkbox",disabled:!0})," ","Load Store"]}),"\n",(0,a.jsxs)(t.li,{className:"task-list-item",children:[(0,a.jsx)(t.input,{type:"checkbox",checked:!0,disabled:!0})," ","Store Load"]}),"\n",(0,a.jsxs)(t.li,{className:"task-list-item",children:[(0,a.jsx)(t.input,{type:"checkbox",checked:!0,disabled:!0})," ","Store Store"]}),"\n"]}),"\n",(0,a.jsx)(t.h3,{id:"如何理解因无法验证仅供参考-1",children:"如何理解（因无法验证，仅供参考）："}),"\n",(0,a.jsx)(t.p,{children:"Store Load 原因同上"}),"\n",(0,a.jsx)(t.p,{children:"当需要 Store 多个值时，如果发现 Store 的值没有在 Cache 中时，则会延迟写入到内存，此时会发生 Store Store 重排序。"}),"\n",(0,a.jsx)(t.h2,{id:"rmo-relaxed-memory-ordering",children:"RMO (Relaxed Memory Ordering)"}),"\n",(0,a.jsx)(t.h3,{id:"can-be-reordered-2",children:"Can be reordered"}),"\n",(0,a.jsxs)(t.ul,{className:"contains-task-list",children:["\n",(0,a.jsxs)(t.li,{className:"task-list-item",children:[(0,a.jsx)(t.input,{type:"checkbox",checked:!0,disabled:!0})," ","Load Load"]}),"\n",(0,a.jsxs)(t.li,{className:"task-list-item",children:[(0,a.jsx)(t.input,{type:"checkbox",checked:!0,disabled:!0})," ","Load Store"]}),"\n",(0,a.jsxs)(t.li,{className:"task-list-item",children:[(0,a.jsx)(t.input,{type:"checkbox",checked:!0,disabled:!0})," ","Store Load"]}),"\n",(0,a.jsxs)(t.li,{className:"task-list-item",children:[(0,a.jsx)(t.input,{type:"checkbox",checked:!0,disabled:!0})," ","Store Store"]}),"\n"]}),"\n",(0,a.jsx)(t.h3,{id:"如何理解因无法验证仅供参考-2",children:"如何理解（因无法验证，仅供参考）："}),"\n",(0,a.jsx)(t.p,{children:"Store Load 和 Store Store 原因同上"}),"\n",(0,a.jsx)(t.p,{children:"如果发现 Load 的值没有在 Cache 中时，则会从内存中读取，此时会发生 Load Load 或者 Load Store 重排序。"}),"\n",(0,a.jsx)(t.h2,{id:"关于-编译器屏障-与-内存屏障",children:"关于 编译器屏障 与 内存屏障"}),"\n",(0,a.jsx)(t.h3,{id:"编译器屏障",children:"编译器屏障"}),"\n",(0,a.jsx)(t.pre,{"data-language":"c","data-theme":"default",children:(0,a.jsxs)(t.code,{"data-language":"c","data-theme":"default",children:[(0,a.jsxs)(t.span,{className:"line",children:[(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-keyword)"},children:"#include"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-string-expression)"},children:"<linux/kernel.h>"})]}),"\n",(0,a.jsx)(t.span,{className:"line",children:" "}),"\n",(0,a.jsxs)(t.span,{className:"line",children:[(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-keyword)"},children:"void"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-function)"},children:"barrier"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-keyword)"},children:"void"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-color-text)"},children:");"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-comment)"},children:" // 指令重排序只在屏障两边生效"})]})]})}),"\n",(0,a.jsx)(t.p,{children:"抑制编译器重排序优化，不影响硬件对指令的执行顺序。"}),"\n",(0,a.jsx)(t.h3,{id:"内存屏障",children:"内存屏障"}),"\n",(0,a.jsx)(t.pre,{"data-language":"c","data-theme":"default",children:(0,a.jsxs)(t.code,{"data-language":"c","data-theme":"default",children:[(0,a.jsxs)(t.span,{className:"line",children:[(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-keyword)"},children:"#include"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-string-expression)"},children:"<asm/system.h>"})]}),"\n",(0,a.jsx)(t.span,{className:"line",children:" "}),"\n",(0,a.jsxs)(t.span,{className:"line",children:[(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-keyword)"},children:"void"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-function)"},children:"smp_mb"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-keyword)"},children:"void"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-color-text)"},children:");"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-comment)"},children:" // 任何内存访问都将在屏障之前完成"})]}),"\n",(0,a.jsxs)(t.span,{className:"line",children:[(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-keyword)"},children:"void"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-function)"},children:"smp_rmb"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-keyword)"},children:"void"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-color-text)"},children:");"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-comment)"},children:" // 任何内存读访问都将在屏障之前完成（不限制 写访问）"})]}),"\n",(0,a.jsxs)(t.span,{className:"line",children:[(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-keyword)"},children:"void"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-function)"},children:"smp_wmb"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-keyword)"},children:"void"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-color-text)"},children:");"}),(0,a.jsx)(t.span,{style:{color:"var(--shiki-token-comment)"},children:" // 任何内存写访问都将在屏障之前完成（不限制 读访问）"})]})]})}),"\n",(0,a.jsx)(t.p,{children:"抑制硬件级别的重排序优化。"})]})}let c={MDXContent:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:t}=Object.assign({},(0,l.a)(),e.components);return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(_createMdxContent,{...e})}):_createMdxContent(e)},pageOpts:{filePath:"pages/articles/memory_consistency_model.mdx",route:"/articles/memory_consistency_model",frontMatter:{title:"内存一致性模型",date:"2023-02-13T00:00:00.000Z",tags:["cpu","memory","consistency","architecture"],hidden:!1,draft:!1},timestamp:1768652696e3,pageMap:[{kind:"Meta",data:{profile:{type:"separator",title:"Profile"},index:"Home",tags:"Tags",archive:"Archive",articles:{type:"page",display:"hidden"}}},{kind:"MdxPage",name:"archive",route:"/archive",frontMatter:{title:"Archive"}},{kind:"Folder",name:"articles",route:"/articles",children:[{kind:"Meta",data:{"*":{display:"hidden"},lock:"关于锁 (Lock)",program_language:"Program Language",kernel:"Linux Kernel",i3wm:"i3wm",kafka:"Kafka",cache_coherence:"缓存一致性",memory_consistency_model:"内存一致性模型",passphraseless_ssh:"Docker SSH 免密登录"}},{kind:"MdxPage",name:"cache_coherence",route:"/articles/cache_coherence",frontMatter:{title:"缓存一致性",date:"2023-02-13T00:00:00.000Z",tags:["cpu","cache","coherence","memory"],hidden:!1,draft:!1}},{kind:"MdxPage",name:"i3wm",route:"/articles/i3wm",frontMatter:{title:"i3wm",date:"2023-02-24T00:00:00.000Z",tags:["misc","linux","i3","window-manager"],hidden:!1,draft:!1}},{kind:"MdxPage",name:"kafka",route:"/articles/kafka",frontMatter:{title:"Kafka",date:"2023-02-14T00:00:00.000Z",tags:["misc","kafka","messaging","streaming"],hidden:!1,draft:!1}},{kind:"MdxPage",name:"kernel",route:"/articles/kernel",frontMatter:{title:"Linux Kernel",date:"2023-02-26T00:00:00.000Z",tags:["misc","kernel","os","linux"],hidden:!1,draft:!1}},{kind:"MdxPage",name:"lock",route:"/articles/lock",frontMatter:{title:"关于锁 (Lock)",date:"2023-06-30T00:00:00.000Z",tags:["multithreading","concurrency","locks","synchronization"],hidden:!1,draft:!1}},{kind:"MdxPage",name:"memory_consistency_model",route:"/articles/memory_consistency_model",frontMatter:{title:"内存一致性模型",date:"2023-02-13T00:00:00.000Z",tags:["cpu","memory","consistency","architecture"],hidden:!1,draft:!1}},{kind:"MdxPage",name:"passphraseless_ssh",route:"/articles/passphraseless_ssh",frontMatter:{title:"Docker SSH 免密登录",date:"2023-02-12T00:00:00.000Z",tags:["docker","ssh","security","devops"],hidden:!1,draft:!1}},{kind:"MdxPage",name:"program_language",route:"/articles/program_language",frontMatter:{title:"Program Language",date:"2023-03-05T00:00:00.000Z",tags:["misc","programming-language","compilers","parsing"],hidden:!1,draft:!1}}]},{kind:"MdxPage",name:"index",route:"/",frontMatter:{title:"Home"}},{kind:"MdxPage",name:"tags",route:"/tags",frontMatter:{title:"Tags"}}],flexsearch:{codeblocks:!0},title:"内存一致性模型",headings:d},pageNextRoute:"/articles/memory_consistency_model",nextraLayout:s.ZP,themeConfig:i.Z};var h=(0,n.j)(c)},9251:function(e,t,r){"use strict";r.d(t,{Z:function(){return o}});var a=r(5250);r(79);var n=r(6963),s=r.n(n),i=r(2630);let formatDateValue=e=>{if(!e)return null;if(e instanceof Date)return e.toISOString().slice(0,10);let t=e.trim();if(!t)return null;let r=new Date(t);return Number.isNaN(r.getTime())?t:r.toISOString().slice(0,10)},getDateMeta=e=>{let t=formatDateValue(null==e?void 0:e.updatedAt);if(t)return{label:"Updated on",value:t};let r=formatDateValue(null==e?void 0:e.createdAt);if(r)return{label:"Created on",value:r};let a=formatDateValue(null==e?void 0:e.date);return a?{label:"Published on",value:a}:null},normalizeTags=e=>Array.isArray(e)?e.map(e=>String(e).trim()).filter(Boolean):"string"==typeof e&&e.trim()?[e.trim()]:[];function ProfileSidebarHeader(){return(0,a.jsxs)("div",{className:"tw-flex tw-flex-col tw-gap-3 tw-px-1",children:[(0,a.jsx)("img",{src:"/avatar.jpg",alt:"Jover avatar",className:"tw-h-14 tw-w-14 tw-rounded-full tw-bg-neutral-200 tw-object-cover tw-ring-1 tw-ring-neutral-200 dark:tw-bg-neutral-800 dark:tw-ring-neutral-700"}),(0,a.jsxs)("div",{className:"tw-flex tw-flex-col tw-gap-1",children:[(0,a.jsx)("div",{className:"tw-text-base tw-font-semibold",children:"Jover"}),(0,a.jsx)("div",{className:"tw-text-xs tw-text-muted",children:"Rust/C++/编译器/操作系统/数据库"})]})]})}let l={logo:(0,a.jsx)("span",{children:"JoverZhang"}),project:{link:"https://github.com/JoverZhang"},navbar:{extraContent:(0,a.jsx)("nav",{style:{display:"flex",gap:"1rem",fontSize:"0.95rem"},children:(0,a.jsx)("a",{href:"/tags",style:{fontWeight:600},children:"Tags"})})},components:{h1:e=>{let{children:t,...r}=e,{frontMatter:n}=(0,i.ZR)(),l=getDateMeta(n),o=normalizeTags(null==n?void 0:n.tags),d=o.length>0&&!(null==n?void 0:n.hidden)&&!(null==n?void 0:n.draft),c=["tw-text-4xl","tw-font-semibold",r.className].filter(Boolean).join(" ");return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h1",{...r,className:c,children:t}),d?(0,a.jsx)("div",{className:"tw-mt-3 tw-flex tw-flex-wrap tw-gap-2",children:o.map(e=>(0,a.jsx)(s(),{href:"/articles?tag=".concat(encodeURIComponent(e)),className:"tw-rounded-full tw-border tw-border-gray-200 dark:tw-border-gray-700 tw-px-2.5 tw-py-0.5 tw-text-xs tw-text-muted",children:e},e))}):null,l?(0,a.jsxs)("p",{className:"tw-mt-2 tw-text-sm tw-text-muted",children:[l.label," ",l.value]}):null]})}},sidebar:{titleComponent:e=>{let{title:t,type:r}=e;return"separator"===r&&"Profile"===t?(0,a.jsx)(ProfileSidebarHeader,{}):(0,a.jsx)("span",{children:t})}},gitTimestamp:null,head:()=>(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0"}),(0,a.jsx)("meta",{name:"description",content:"JoverZhang home"}),(0,a.jsx)("title",{children:"JoverZhang Home"})]}),footer:{text:(0,a.jsx)(function(){return(0,a.jsx)("footer",{style:{padding:"2rem 0",textAlign:"center",fontSize:"0.9rem"},children:(0,a.jsxs)("span",{children:["\xa9 ",new Date().getFullYear()," JoverZhang"]})})},{})}};var o=l},8625:function(){}},function(e){e.O(0,[335,467,774,888,179],function(){return e(e.s=2034)}),_N_E=e.O()}]);